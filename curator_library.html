<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reading Library ‚Äî Curator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f0e8;
    --bg-texture: #ede8df;
    --surface: #faf7f2;
    --surface2: #f0ebe0;
    --border: #ddd6c8;
    --border2: #c8bfaf;
    --text: #2a2418;
    --text-muted: #6b5f4e;
    --text-dim: #9e9080;
    --accent: #8b5e2a;
    --accent-dim: rgba(139,94,42,0.08);
    --accent-glow: rgba(139,94,42,0.18);
    --liked: #2e7d52;
    --liked-bg: rgba(46,125,82,0.08);
    --saved: #1a5c8a;
    --saved-bg: rgba(26,92,138,0.08);
    --bookmarked: #7a2e6e;
    --bookmarked-bg: rgba(122,46,110,0.08);
    --geo: #8b4513;
    --fiscal: #1a4a7a;
    --monetary: #4a2a7a;
    --other: #6b5f4e;
    --shadow: rgba(42,36,24,0.08);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Source Sans 3', sans-serif;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 20% 0%, rgba(210,190,160,0.4) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(200,180,150,0.3) 0%, transparent 50%);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
    position: sticky;
    top: 0;
    background: rgba(245,240,232,0.94);
    backdrop-filter: blur(12px);
    z-index: 100;
    box-shadow: 0 1px 0 var(--border), 0 2px 8px var(--shadow);
  }

  .header-left {
    display: flex;
    align-items: baseline;
    gap: 16px;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    color: var(--accent);
    letter-spacing: -0.02em;
    text-decoration: none;
  }

  .logo-sub {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .header-nav {
    display: flex;
    gap: 4px;
  }

  .nav-link {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 14px;
    border-radius: 6px;
    letter-spacing: 0.05em;
    transition: all 0.15s;
    border: 1px solid transparent;
  }

  .nav-link:hover { color: var(--text); background: var(--surface2); }
  .nav-link.active {
    color: var(--accent);
    background: var(--accent-dim);
    border-color: rgba(139,94,42,0.2);
  }

  /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 32px 80px;
  }

  /* ‚îÄ‚îÄ Page title ‚îÄ‚îÄ */
  .page-header {
    margin-bottom: 28px;
  }

  .page-title {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    font-weight: 400;
    color: var(--text);
    letter-spacing: -0.03em;
    line-height: 1.1;
    margin-bottom: 6px;
  }

  .page-title em { color: var(--accent); font-style: italic; }

  .page-meta {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ */
  .stats-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .stat-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.04em;
    box-shadow: 0 1px 3px var(--shadow);
  }

  .stat-pill strong {
    font-size: 18px;
    font-family: 'Playfair Display', serif;
    font-weight: 400;
    color: var(--text);
    letter-spacing: -0.02em;
  }

  .stat-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
  .controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 220px;
    max-width: 380px;
  }

  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 13px;
    pointer-events: none;
  }

  input[type="search"] {
    width: 100%;
    padding: 9px 12px 9px 34px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    box-shadow: inset 0 1px 3px rgba(42,36,24,0.06);
  }

  input[type="search"]:focus {
    border-color: var(--accent);
    box-shadow: inset 0 1px 3px rgba(42,36,24,0.06), 0 0 0 3px rgba(139,94,42,0.1);
  }
  input[type="search"]::placeholder { color: var(--text-dim); }

  .filter-group { display: flex; gap: 4px; }

  .filter-btn {
    padding: 7px 13px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    box-shadow: 0 1px 2px var(--shadow);
  }

  .filter-btn:hover { border-color: var(--border2); color: var(--text); background: var(--bg-texture); }
  .filter-btn.active-liked    { background: var(--liked-bg);  border-color: var(--liked);  color: var(--liked); }
  .filter-btn.active-saved    { background: var(--saved-bg);  border-color: var(--saved);  color: var(--saved); }
  .filter-btn.active-all      { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
  .filter-btn.active-bookmarked { background: var(--bookmarked-bg); border-color: var(--bookmarked); color: var(--bookmarked); }

  .select-filter {
    padding: 7px 28px 7px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.04em;
    cursor: pointer;
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239e9080' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: all 0.15s;
    box-shadow: 0 1px 2px var(--shadow);
  }

  .select-filter:hover { border-color: var(--border2); color: var(--text); }
  .select-filter:focus { border-color: var(--accent); }
  .select-filter option { background: var(--surface); color: var(--text); }

  .result-count {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    margin-left: auto;
    letter-spacing: 0.04em;
    align-self: center;
  }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .table-wrap {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px var(--shadow);
    background: var(--surface);
  }

  table { width: 100%; border-collapse: collapse; }

  thead {
    background: var(--bg-texture);
    border-bottom: 2px solid var(--border);
  }

  th {
    padding: 11px 16px;
    text-align: left;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    white-space: nowrap;
    user-select: none;
  }

  th.sortable { cursor: pointer; }
  th.sortable:hover { color: var(--text-muted); }
  th.sort-asc::after  { content: ' ‚Üë'; color: var(--accent); }
  th.sort-desc::after { content: ' ‚Üì'; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    cursor: pointer;
    background: var(--surface);
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(139,94,42,0.04); }

  td { padding: 14px 16px; vertical-align: top; }

  .td-title { max-width: 380px; }

  .article-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-note {
    font-size: 11px;
    color: var(--text-muted);
    font-style: italic;
    font-family: 'Playfair Display', serif;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
  }

  .td-source { white-space: nowrap; }

  .source-name {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
  }

  .cat-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.04em;
    font-weight: 500;
    white-space: nowrap;
    border: 1px solid transparent;
  }

  .cat-geo_major, .cat-geo_minor { background: rgba(139,69,19,0.08); color: var(--geo); border-color: rgba(139,69,19,0.2); }
  .cat-fiscal      { background: rgba(26,74,122,0.08); color: var(--fiscal); border-color: rgba(26,74,122,0.2); }
  .cat-monetary    { background: rgba(74,42,122,0.08); color: var(--monetary); border-color: rgba(74,42,122,0.2); }
  .cat-geo_other,
  .cat-technology,
  .cat-other,
  .cat-unknown     { background: rgba(107,95,78,0.08); color: var(--other); border-color: rgba(107,95,78,0.2); }

  .score-val {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  .score-bar {
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 4px;
    width: 48px;
    overflow: hidden;
  }

  .score-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--accent);
  }

  .type-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.04em;
    white-space: nowrap;
    border: 1px solid transparent;
  }

  .type-liked      { background: var(--liked-bg);      color: var(--liked);      border-color: rgba(46,125,82,0.2); }
  .type-saved      { background: var(--saved-bg);      color: var(--saved);      border-color: rgba(26,92,138,0.2); }
  .type-bookmarked { background: var(--saved-bg);      color: var(--saved);      border-color: rgba(26,92,138,0.2); }

  .date-val {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .actions-cell { white-space: nowrap; }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.04em;
    text-decoration: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    background: var(--bg);
    cursor: pointer;
    transition: all 0.15s;
    margin-right: 4px;
    box-shadow: 0 1px 2px var(--shadow);
  }

  .action-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

  .action-btn.deep-dive {
    border-color: rgba(122,46,110,0.3);
    color: var(--bookmarked);
    background: var(--bookmarked-bg);
  }
  .action-btn.deep-dive:hover { border-color: var(--bookmarked); background: rgba(122,46,110,0.15); }

  .action-btn.start-dive {
    border-color: rgba(139,94,42,0.3);
    color: var(--accent);
    background: var(--accent-dim);
  }
  .action-btn.start-dive:hover { border-color: var(--accent); background: var(--accent-glow); }

  /* ‚îÄ‚îÄ Appearances ‚îÄ‚îÄ */
  .appearances {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 3px;
  }
  .appearances span { color: var(--accent); font-weight: 500; }

  /* ‚îÄ‚îÄ Empty / Loading ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 64px 32px;
    color: var(--text-dim);
    background: var(--surface);
  }
  .empty-state-icon { font-size: 32px; margin-bottom: 12px; display: block; }
  .empty-state-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .empty-state-sub { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.04em; }

  .loading {
    text-align: center;
    padding: 64px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--text-dim);
    letter-spacing: 0.06em;
    background: var(--surface);
  }
  .loading::after {
    content: '';
    display: inline-block;
    width: 12px; height: 12px;
    border: 1.5px solid var(--border2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: 10px;
    vertical-align: middle;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  tbody tr { animation: fadeIn 0.2s ease both; }

  /* ‚îÄ‚îÄ Archive footer link ‚îÄ‚îÄ */
  .archive-footer {
    margin-top: 32px;
    text-align: center;
  }
  .archive-link {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    text-decoration: none;
    letter-spacing: 0.06em;
    border-bottom: 1px dashed var(--border2);
    padding-bottom: 1px;
    transition: color 0.15s;
  }
  .archive-link:hover { color: var(--text-muted); }

  /* ‚îÄ‚îÄ Deep Dive Modal ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(42,36,24,0.45);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px 32px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 16px 48px rgba(42,36,24,0.2);
    animation: modalIn 0.2s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: translateY(-8px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 400;
    color: var(--text);
    margin-bottom: 4px;
    letter-spacing: -0.02em;
  }

  .modal-article-title {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 20px;
    font-style: italic;
    font-family: 'Playfair Display', serif;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .modal-field { margin-bottom: 16px; }

  .modal-label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .modal-input,
  .modal-textarea {
    width: 100%;
    padding: 9px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    box-shadow: inset 0 1px 3px rgba(42,36,24,0.06);
  }

  .modal-textarea {
    resize: vertical;
    min-height: 72px;
    line-height: 1.5;
  }

  .modal-input:focus,
  .modal-textarea:focus {
    border-color: var(--accent);
    box-shadow: inset 0 1px 3px rgba(42,36,24,0.06), 0 0 0 3px rgba(139,94,42,0.1);
  }

  .modal-input::placeholder,
  .modal-textarea::placeholder { color: var(--text-dim); }

  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .modal-btn {
    padding: 8px 18px;
    border-radius: 7px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid var(--border);
  }

  .modal-btn.cancel {
    background: transparent;
    color: var(--text-muted);
  }
  .modal-btn.cancel:hover { background: var(--surface2); color: var(--text); }

  .modal-btn.execute {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    font-weight: 500;
  }
  .modal-btn.execute:hover { background: #7a5224; border-color: #7a5224; }
  .modal-btn.execute:disabled { opacity: 0.6; cursor: not-allowed; }

  .modal-status {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    margin-top: 12px;
    padding: 8px 12px;
    border-radius: 6px;
    display: none;
    letter-spacing: 0.03em;
  }
  .modal-status.running { display: block; background: var(--accent-dim); color: var(--accent); }
  .modal-status.success { display: block; background: var(--liked-bg); color: var(--liked); }
  .modal-status.error   { display: block; background: rgba(180,60,60,0.08); color: #b43c3c; }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .td-source, th:nth-child(3) { display: none; }
  }
  @media (max-width: 700px) {
    main { padding: 16px; }
    .td-title { max-width: 220px; }
    .controls { gap: 6px; }
    .modal { margin: 16px; padding: 20px; }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Deep Dive Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="dive-modal" onclick="closeDiveModal(event)">
  <div class="modal">
    <div class="modal-title">‚ú® Start Deep Dive</div>
    <div class="modal-article-title" id="modal-article-title"></div>

    <div class="modal-field">
      <label class="modal-label" for="dive-interest">Why are you interested?</label>
      <textarea
        class="modal-textarea"
        id="dive-interest"
        placeholder="e.g. I want to understand the fiscal implications and how this connects to recent Fed policy‚Ä¶"
        rows="3"
      ></textarea>
    </div>

    <div class="modal-field">
      <label class="modal-label" for="dive-focus">Focus areas <span style="color:var(--text-dim);font-style:italic;text-transform:none;letter-spacing:0">(optional)</span></label>
      <input
        class="modal-input"
        id="dive-focus"
        type="text"
        placeholder="e.g. monetary policy, geopolitical risk, market impact"
      >
    </div>

    <div class="modal-status" id="modal-status"></div>

    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeDiveModal()">Cancel</button>
      <button class="modal-btn execute" id="dive-execute-btn" onclick="executeDive()">Execute Deep Dive</button>
    </div>
  </div>
</div>

<header>
  <div class="header-left">
    <a href="/curator_briefing.html" class="logo">üìö Curator</a>
    <span class="logo-sub">Reading Library</span>
  </div>
  <nav class="header-nav">
    <a href="/" class="nav-link">Daily</a>
    <a href="/curator_library.html" class="nav-link active">Library</a>
    <a href="/interests/2026/deep-dives/index.html" class="nav-link">Deep Dives</a>
    <a href="/curator_priorities.html" class="nav-link">Priorities</a>
  </nav>
</header>

<main>
  <div class="page-header">
    <h1 class="page-title">Your <em>reading library</em></h1>
    <p class="page-meta" id="meta-line">Loading articles...</p>
  </div>

  <div class="stats-bar" id="stats-bar">
    <div class="stat-pill">
      <div class="stat-dot" style="background:var(--liked)"></div>
      <strong id="stat-liked">‚Äî</strong> liked
    </div>
    <div class="stat-pill">
      <div class="stat-dot" style="background:var(--saved)"></div>
      <strong id="stat-saved">‚Äî</strong> saved
    </div>
    <div class="stat-pill" style="margin-left:auto">
      <strong id="stat-total">‚Äî</strong> total
    </div>
  </div>

  <div class="controls">
    <div class="search-wrap">
      <span class="search-icon">‚åï</span>
      <input type="search" id="search-input" placeholder="Search titles, sources, notes‚Ä¶">
    </div>
    <div class="filter-group" id="type-filters">
      <button class="filter-btn active-all" data-type="all">All</button>
      <button class="filter-btn" data-type="liked">üëç Liked</button>
      <button class="filter-btn" data-type="saved">üîñ Saved</button>
    </div>
    <select class="select-filter" id="category-filter">
      <option value="all">All categories</option>
      <option value="geo_major">Geo Major</option>
      <option value="geo_minor">Geo Minor</option>
      <option value="geo_other">Geo Other</option>
      <option value="fiscal">Fiscal</option>
      <option value="monetary">Monetary</option>
      <option value="technology">Technology</option>
      <option value="other">Other</option>
    </select>
    <span class="result-count" id="result-count"></span>
  </div>

  <div class="table-wrap">
    <div class="loading" id="loading">Loading your library</div>
    <table id="library-table" style="display:none">
      <thead>
        <tr>
          <th class="sortable" data-col="date" data-dir="desc">Date ‚Üì</th>
          <th>Title &amp; Note</th>
          <th class="sortable" data-col="source">Source</th>
          <th class="sortable" data-col="category">Category</th>
          <th class="sortable" data-col="score" data-dir="desc">Score</th>
          <th>Type</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
    <div class="empty-state" id="empty-state" style="display:none">
      <span class="empty-state-icon">üîç</span>
      <div class="empty-state-title">No articles found</div>
      <div class="empty-state-sub">Try adjusting your filters or search term</div>
    </div>
  </div>

  <div class="archive-footer">
    <a href="/curator_index.html" class="archive-link">View full archive ‚Üí</a>
  </div>
</main>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allArticles = [];
let sortCol = 'date';
let sortDir = 'desc';
let typeFilter = 'all';
let categoryFilter = 'all';
let searchQuery = '';

// Active dive state
let diveArticle = null;

// ‚îÄ‚îÄ Data loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const res = await fetch('/api/library');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    allArticles = data.articles || [];
    updateStats();
    render();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('library-table').style.display = 'table';
  } catch (err) {
    document.getElementById('loading').textContent = `Error loading data: ${err.message}`;
    console.error(err);
  }
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  const liked      = allArticles.filter(a => a.type === 'liked').length;
  const saved      = allArticles.filter(a => a.type === 'saved').length;
  document.getElementById('stat-liked').textContent      = liked;
  document.getElementById('stat-saved').textContent      = saved;
  document.getElementById('stat-total').textContent      = allArticles.length;

  const dates = allArticles.map(a => a.date).filter(Boolean).sort();
  if (dates.length) {
    const fmt = d => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    document.getElementById('meta-line').textContent =
      `${allArticles.length} articles saved ¬∑ ${fmt(dates[0])} ‚Äì ${fmt(dates[dates.length-1])}`;
  }
}

// ‚îÄ‚îÄ Filter & sort ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filteredArticles() {
  return allArticles
    .filter(a => {
      if (typeFilter !== 'all' && a.type !== typeFilter) return false;
      if (categoryFilter !== 'all' && a.category !== categoryFilter) return false;
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        if (!`${a.title} ${a.source} ${a.note||''}`.toLowerCase().includes(q)) return false;
      }
      return true;
    })
    .sort((a, b) => {
      let va = a[sortCol] ?? '';
      let vb = b[sortCol] ?? '';
      if (sortCol === 'score') { va = parseFloat(va)||0; vb = parseFloat(vb)||0; }
      if (sortCol === 'date')  { va = va.replace(/\D/g,''); vb = vb.replace(/\D/g,''); }
      if (va < vb) return sortDir === 'asc' ? -1 : 1;
      if (va > vb) return sortDir === 'asc' ?  1 : -1;
      return 0;
    });
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const rows  = filteredArticles();
  const tbody = document.getElementById('table-body');
  const empty = document.getElementById('empty-state');
  const count = document.getElementById('result-count');

  count.textContent = rows.length === allArticles.length
    ? `${rows.length} articles`
    : `${rows.length} of ${allArticles.length}`;

  if (!rows.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = rows.map((a, i) => {
    const date = a.date
      ? new Date(a.date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})
      : '‚Äî';
    const scoreNum = parseFloat(a.score) || 0;
    const scorePct = (scoreNum / 10 * 100).toFixed(0);
    const typeLabel = a.type === 'liked' ? 'üëç Liked'
                    : a.type === 'saved' ? 'üîñ Saved'
                    : 'üìå Bookmarked';
    const catClass = `cat-${(a.category||'other').toLowerCase().replace(/\s+/g,'_')}`;
    const catLabel = (a.category||'other').replace(/_/g,' ');

    const noteHtml = a.note
      ? `<div class="article-note" title="${escHtml(a.note)}">${escHtml(a.note.substring(0,80))}${a.note.length > 80 ? '‚Ä¶' : ''}</div>`
      : '';

    const appearancesHtml = a.appearances && a.appearances.length > 1
      ? `<div class="appearances">Appeared <span>${a.appearances.length}√ó</span> ¬∑ peak score <span>${Math.max(...a.appearances.map(x => x.score||0)).toFixed(1)}</span></div>`
      : '';

    // Deep dive button: show existing dive OR offer to start one
    let diveBtn = '';
    if (a.deep_dive_path) {
      // Convert absolute path to web URL
      // /Users/.../interests/2026/deep-dives/xxx.md ‚Üí /interests/2026/deep-dives/xxx.html
      const pathMatch = a.deep_dive_path.match(/interests\/(.+\.md)$/);
      if (pathMatch) {
        const relativePath = pathMatch[1].replace(/\.md$/, '.html');
        const diveUrl = `/interests/${relativePath}`;
        diveBtn = `<a class="action-btn deep-dive" href="${diveUrl}" target="_blank" title="View deep dive">üî≠ Deep Dive</a>`;
      }
    } else if (a.hash_id) {
      diveBtn = `<button class="action-btn start-dive" data-hash-id="${escHtml(a.hash_id||'')}">‚ú® Start Dive</button>`;
    }

    return `<tr style="animation-delay:${Math.min(i*20,300)}ms" onclick="window.open('${escHtml(a.url)}','_blank')">
      <td><span class="date-val">${date}</span></td>
      <td class="td-title">
        <div class="article-title">${escHtml(a.title)}</div>
        ${noteHtml}
        ${appearancesHtml}
      </td>
      <td class="td-source"><span class="source-name">${escHtml(a.source||'')}</span></td>
      <td><span class="cat-badge ${catClass}">${catLabel}</span></td>
      <td>
        <div class="score-val">${scoreNum > 0 ? scoreNum.toFixed(1) : '‚Äî'}</div>
        ${scoreNum > 0 ? `<div class="score-bar"><div class="score-fill" style="width:${scorePct}%"></div></div>` : ''}
      </td>
      <td><span class="type-badge type-${a.type}">${typeLabel}</span></td>
      <td class="actions-cell" onclick="event.stopPropagation()">
        <a class="action-btn" href="${escHtml(a.url)}" target="_blank" rel="noopener">‚Üó Read</a>
        ${diveBtn}
      </td>
    </tr>`;
  }).join('');

  // Attach event listeners to Start Dive buttons
  document.querySelectorAll('.start-dive').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const article = allArticles.find(a => a.hash_id === btn.dataset.hashId);
      console.log('Start Dive clicked, hash_id:', btn.dataset.hashId, 'article found:', !!article);
      if (article) openDiveModal(e, article);
    });
  });
}

function escHtml(str) {
  return String(str||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ Deep Dive Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDiveModal(event, article) {
  event.stopPropagation();
  diveArticle = article;
  document.getElementById('modal-article-title').textContent = article.title;
  document.getElementById('dive-interest').value = '';
  document.getElementById('dive-focus').value = '';
  document.getElementById('modal-status').className = 'modal-status';
  document.getElementById('modal-status').textContent = '';
  document.getElementById('dive-execute-btn').disabled = false;
  document.getElementById('dive-execute-btn').textContent = 'Execute Deep Dive';
  document.getElementById('dive-modal').classList.add('open');
  setTimeout(() => document.getElementById('dive-interest').focus(), 100);
}

function closeDiveModal(event) {
  // If clicking overlay background (not modal content), close
  if (event && event.target !== document.getElementById('dive-modal')) return;
  document.getElementById('dive-modal').classList.remove('open');
  diveArticle = null;
}

async function executeDive() {
  if (!diveArticle) return;

  const interest = document.getElementById('dive-interest').value.trim();
  const focus    = document.getElementById('dive-focus').value.trim();

  if (!interest) {
    document.getElementById('dive-interest').focus();
    document.getElementById('dive-interest').style.borderColor = '#b43c3c';
    setTimeout(() => document.getElementById('dive-interest').style.borderColor = '', 1500);
    return;
  }

  const btn    = document.getElementById('dive-execute-btn');
  const status = document.getElementById('modal-status');

  btn.disabled = true;
  btn.textContent = 'Running‚Ä¶';
  status.className = 'modal-status running';
  status.textContent = '‚è≥ Deep dive in progress ‚Äî this may take a minute‚Ä¶';

  try {
    const params = new URLSearchParams({
      hash_id:  diveArticle.hash_id,
      interest: interest,
      focus:    focus
    });

    const res = await fetch(`/deepdive?${params.toString()}`);

    if (res.ok) {
      status.className = 'modal-status success';
      status.textContent = '‚úÖ Deep dive complete! Reloading library‚Ä¶';
      btn.textContent = 'Done';

      // Mark article as having a deep dive locally so button updates
      const article = allArticles.find(a => a.hash_id === diveArticle.hash_id);
      if (article) article.deep_dive_path = 'completed';
      render();

      setTimeout(() => {
        document.getElementById('dive-modal').classList.remove('open');
        diveArticle = null;
        loadData(); // reload to get fresh state
      }, 2000);
    } else {
      const text = await res.text();
      status.className = 'modal-status error';
      status.textContent = `‚ùå Error: ${text.substring(0,120)}`;
      btn.disabled = false;
      btn.textContent = 'Retry';
    }
  } catch (err) {
    status.className = 'modal-status error';
    status.textContent = `‚ùå Network error: ${err.message}`;
    btn.disabled = false;
    btn.textContent = 'Retry';
  }
}

// Close modal on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('dive-modal').classList.remove('open');
});

// ‚îÄ‚îÄ Sort headers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    sortDir = sortCol === col ? (sortDir === 'asc' ? 'desc' : 'asc') : (th.dataset.dir || 'asc');
    sortCol = col;
    document.querySelectorAll('th.sortable').forEach(t => t.classList.remove('sort-asc','sort-desc'));
    th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
    render();
  });
});

// ‚îÄ‚îÄ Type filter buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('#type-filters .filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    typeFilter = btn.dataset.type;
    document.querySelectorAll('#type-filters .filter-btn').forEach(b => b.className = 'filter-btn');
    btn.classList.add(`active-${typeFilter === 'all' ? 'all' : typeFilter}`);
    render();
  });
});

// ‚îÄ‚îÄ Category filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('category-filter').addEventListener('change', e => {
  categoryFilter = e.target.value;
  render();
});

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let searchTimeout;
document.getElementById('search-input').addEventListener('input', e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { searchQuery = e.target.value.trim(); render(); }, 200);
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData();
</script>
</body>
</html>
